{"version":3,"sources":["../src/DownloadedUpdateHelper.ts"],"names":[],"mappings":"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","sourcesContent":["import { UpdateInfo } from \"builder-util-runtime\"\nimport { createHash } from \"crypto\"\nimport { createReadStream } from \"fs\"\nimport isEqual from \"lodash.isequal\"\nimport { Logger, ResolvedUpdateFileInfo } from \"./main\"\nimport { pathExists, readJson, emptyDir, outputJson } from \"fs-extra-p\"\nimport * as path from \"path\"\n\n/** @private **/\nexport class DownloadedUpdateHelper {\n  private _file: string | null = null\n  private _packageFile: string | null = null\n\n  private versionInfo: UpdateInfo | null = null\n  private fileInfo: ResolvedUpdateFileInfo | null = null\n\n  constructor(readonly cacheDir: string) {\n  }\n\n  get file() {\n    return this._file\n  }\n\n  get packageFile() {\n    return this._packageFile\n  }\n\n  async validateDownloadedPath(updateFile: string, versionInfo: UpdateInfo, fileInfo: ResolvedUpdateFileInfo, logger: Logger): Promise<string | null> {\n    if (this.versionInfo != null && this.file === updateFile && this.fileInfo != null) {\n      // update has already been downloaded from this running instance\n      // check here only existence, not checksum\n      if (isEqual(this.versionInfo, versionInfo) && isEqual(this.fileInfo.info, fileInfo.info) && (await pathExists(updateFile))) {\n        return updateFile\n      }\n      else {\n        return null\n      }\n    }\n\n    // update has already been downloaded from some previous app launch\n    const cachedUpdateFile = await this.getValidCachedUpdateFile(fileInfo, logger)\n    if (cachedUpdateFile == null) {\n      return null\n    }\n    logger.info(`Update has already been downloaded to ${updateFile}).`)\n    return cachedUpdateFile\n  }\n\n  setDownloadedFile(downloadedFile: string, packageFile: string | null, versionInfo: UpdateInfo, fileInfo: ResolvedUpdateFileInfo) {\n    this._file = downloadedFile\n    this._packageFile = packageFile\n    this.versionInfo = versionInfo\n    this.fileInfo = fileInfo\n  }\n\n  async cacheUpdateInfo(updateFileName: string) {\n    const data: CachedUpdateInfo = {\n      fileName: updateFileName,\n      sha512: this.fileInfo!!.info.sha512,\n    }\n    await outputJson(path.join(this.cacheDir, \"update-info.json\"), data)\n  }\n\n  async clear() {\n    this._file = null\n    this._packageFile = null\n    this.versionInfo = null\n    this.fileInfo = null\n    await this.cleanCacheDir()\n  }\n\n  private async cleanCacheDir(): Promise<void> {\n    try {\n      // remove stale data\n      await emptyDir(this.cacheDir)\n    }\n    catch (ignore) {\n      // ignore\n    }\n  }\n\n  private async getValidCachedUpdateFile(fileInfo: ResolvedUpdateFileInfo, logger: Logger): Promise<string | null> {\n    let cachedInfo: CachedUpdateInfo\n    const updateInfoFile = path.join(this.cacheDir, \"update-info.json\")\n    try {\n      cachedInfo = await readJson(updateInfoFile)\n    }\n    catch (e) {\n      let message = `No cached update info available`\n      if (e.code !== \"ENOENT\") {\n        await this.cleanCacheDir()\n        message += ` (error on read: ${e.message})`\n      }\n      logger.info(message)\n      return null\n    }\n\n    if (cachedInfo.fileName == null) {\n      logger.warn(`Cached update info is corrupted: no fileName, directory for cached update will be cleaned`)\n      await this.cleanCacheDir()\n      return null\n    }\n\n    if (fileInfo.info.sha512 !== cachedInfo.sha512) {\n      logger.info(`Cached update sha512 checksum doesn't match the latest available update. New update must be downloaded. Cached: ${cachedInfo.sha512}, expected: ${fileInfo.info.sha512}. Directory for cached update will be cleaned`)\n      await this.cleanCacheDir()\n      return null\n    }\n\n    const updateFile = path.join(this.cacheDir, cachedInfo.fileName)\n    if (!(await pathExists(updateFile))) {\n      logger.info(\"Cached update file doesn't exist, directory for cached update will be cleaned\")\n      await this.cleanCacheDir()\n      return null\n    }\n\n    const sha512 = await hashFile(updateFile)\n    if (fileInfo.info.sha512 !== sha512) {\n      logger.warn(`Sha512 checksum doesn't match the latest available update. New update must be downloaded. Cached: ${sha512}, expected: ${fileInfo.info.sha512}`)\n      await this.cleanCacheDir()\n      return null\n    }\n    return updateFile\n  }\n}\n\ninterface CachedUpdateInfo {\n  fileName: string\n  sha512: string\n}\n\nfunction hashFile(file: string, algorithm: string = \"sha512\", encoding: \"base64\" | \"hex\" = \"base64\", options?: any) {\n  return new Promise<string>((resolve, reject) => {\n    const hash = createHash(algorithm)\n    hash\n      .on(\"error\", reject)\n      .setEncoding(encoding)\n\n    createReadStream(file, {...options, highWaterMark: 1024 * 1024 /* better to use more memory but hash faster */})\n      .on(\"error\", reject)\n      .on(\"end\", () => {\n        hash.end()\n        resolve(hash.read() as string)\n      })\n      .pipe(hash, {end: false})\n  })\n}"],"sourceRoot":""}
